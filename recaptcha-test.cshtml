@inherits Custom.Hybrid.RazorTyped
@using System
@using AppCode.Extensions.GoogleRecaptchaV3


@{
  var siteKeyRaw = AllSettings.String("GoogleRecaptcha.SiteKey");
  var siteKey = Kit.SecureData.Parse(siteKeyRaw).Value ?? siteKeyRaw;

  var verifyUrl = Link.To(
  api: "api/Recaptcha/Verify",
  parameters: new { PageId = MyContext.Page.Id, ModuleId = MyContext.Module.Id }
  );

  var wrapperId = "recaptcha-test-" + UniqueKey;
}

<div id="@wrapperId" class="recaptcha-test">
  <h3>reCAPTCHA v3 Test</h3>

  <button type="button" class="btn btn-primary" disabled data-btn>
    Verify reCAPTCHA
  </button>

  <div class="mt-2" data-status></div>
  <pre class="mt-2" data-debug style="font-size:12px;background:#f5f5f5;padding:8px;"></pre>
</div>

@if (!string.IsNullOrWhiteSpace(siteKey))
{
  <script src="https://www.google.com/recaptcha/api.js?render=@siteKey"></script>


  <script>
    (() => {
      const root = document.getElementById("@wrapperId");
      if (!root) return;

      const btn = root.querySelector("[data-btn]");
      const statusEl = root.querySelector("[data-status]");
      const debugEl = root.querySelector("[data-debug]");

      const siteKey = "@siteKey";
      const verifyUrl = "@verifyUrl";

      function setStatus(html) {
        statusEl.innerHTML = html || "";
      }

      // üîë WAIT UNTIL grecaptcha REALLY EXISTS
      function waitForGrecaptcha(timeoutMs = 8000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();

          (function check() {
            if (window.grecaptcha && window.grecaptcha.ready) {
              resolve();
              return;
            }

            if (Date.now() - start > timeoutMs) {
              reject("grecaptcha never loaded");
              return;
            }

            setTimeout(check, 50);
          })();
        });
      }

      async function getToken() {
        await waitForGrecaptcha();
        return new Promise(resolve => {
          grecaptcha.ready(() => {
            grecaptcha.execute(siteKey, { action: "test" }).then(resolve);
          });
        });
      }

      async function verify() {
        btn.disabled = true;
        setStatus("Checking reCAPTCHA‚Ä¶");
        try {
          const token = await getToken();
          const res = await fetch(verifyUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: token
            })
          });

          const text = await res.text();

          const data = JSON.parse(text);

          if (data.isValid === true) {
            btn.disabled = false;
            setStatus(`‚úÖ Valid (score: ${data.score ?? "n/a"})`);
          } else {
            setStatus(`‚ùå Blocked (score: ${data.score ?? "n/a"})`);
          }
        }
        catch (err) {
          setStatus("‚ùå JS error (see debug)");
        }
      }

      btn.addEventListener("click", verify);

      // initial auto-check
      verify();
    })();
  </script>

}
else
{
  <div class="alert alert-warning">
    Missing <code>GoogleRecaptcha.SiteKey</code> in App Settings
  </div>
}
